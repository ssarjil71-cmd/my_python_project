<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - HotelEase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='menu_page.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo">
                <i class="fas fa-hotel"></i>
                HotelEase
            </div>
        </div>
        <div class="nav-center">
            <h1><i class="fas fa-utensils"></i> Menu Management</h1>
        </div>
        <div class="nav-right">
            <a href="/hotel-manager/dashboard" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="menu-container">
        <!-- Alert System -->
        <div class="alert" id="alert" style="display: none;"></div>

        <!-- Category Tabs -->
        <div class="menu-tabs" id="menu-tabs">
            <button class="tab active" data-category="1" onclick="showMenuCategory(1, this)">Starters</button>
            <button class="tab" data-category="2" onclick="showMenuCategory(2, this)">Main Course</button>
            <button class="tab" data-category="3" onclick="showMenuCategory(3, this)">Desserts</button>
            <button class="tab add-tab" onclick="showAddCategoryModal()">+ Add Category</button>
        </div>

        <!-- Menu Content -->
        <div class="menu-content">
            <div class="menu-header">
                <h3 id="category-title">Starters</h3>
                <button class="btn-primary" onclick="showAddDishModal()">
                    <i class="fas fa-plus"></i> Add Dish
                </button>
            </div>
            
            <div id="dishes-container">
                <table class="dishes-table" id="dishes-table">
                    <thead>
                        <tr>
                            <th>Dish Name</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>View Images</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dishes-tbody">
                    </tbody>
                </table>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <i class="fas fa-utensils"></i>
                    <p>No dishes in this category yet</p>
                    <button class="btn-primary" onclick="showAddDishModal()">Add First Dish</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Dish Modal -->
    <div id="dish-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Dish</h3>
                <button class="modal-close" onclick="closeDishModal()">&times;</button>
            </div>
            <form id="dish-form" enctype="multipart/form-data">
                <input type="hidden" id="dish-id" name="dish_id">
                <input type="hidden" id="category-id" name="category_id">
                
                <div class="form-group">
                    <label for="dish-name">Dish Name *</label>
                    <input type="text" id="dish-name" name="name" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="dish-price">Price ($) *</label>
                        <input type="number" id="dish-price" name="price" step="0.01" min="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dish-quantity">Quantity *</label>
                        <input type="number" id="dish-quantity" name="quantity" min="0" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dish-description">Description</label>
                    <textarea id="dish-description" name="description" rows="3" placeholder="Optional description of the dish"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="dish-images">Upload Images (Max 3)</label>
                    <input type="file" id="dish-images" name="images" multiple accept="image/*">
                    <div id="image-selection-info" class="image-info"></div>
                    <small>Supported formats: PNG, JPG, JPEG, GIF</small>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeDishModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="submit-btn">Add Dish</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="category-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Category</h3>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <form id="category-form">
                <div class="form-group">
                    <label for="category-name">Category Name *</label>
                    <input type="text" id="category-name" name="name" required placeholder="e.g., Beverages, Appetizers">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Images Modal -->
    <div id="images-modal" class="modal" style="display: none;">
        <div class="modal-content images-modal-content">
            <div class="modal-header">
                <h3 id="images-modal-title">Dish Images</h3>
                <button class="modal-close" onclick="closeImagesModal()">&times;</button>
            </div>
            <div class="images-modal-body">
                <div id="dish-details"></div>
                <div id="dish-images-container"></div>
            </div>
        </div>
    </div>

    <script>
        let currentCategoryId = 1;
        let isEditMode = false;
        let categories = {1: 'Starters', 2: 'Main Course', 3: 'Desserts'};

        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadDishes(1);
        });

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i> ${message}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.style.display = 'none';
                    alert.style.opacity = '1';
                }, 300);
            }, 4000);
        }

        function loadCategories() {
            fetch('/api/categories')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        categories = data.categories;
                        updateCategoryTabs();
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    showAlert('Error loading categories', 'error');
                });
        }

        function updateCategoryTabs() {
            const tabsContainer = document.getElementById('menu-tabs');
            const addButton = tabsContainer.querySelector('.add-tab');
            
            const existingTabs = tabsContainer.querySelectorAll('.tab:not(.add-tab)');
            existingTabs.forEach(tab => tab.remove());
            
            Object.entries(categories).forEach(([id, name]) => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.setAttribute('data-category', id);
                tab.textContent = name;
                tab.onclick = function() { showMenuCategory(parseInt(id), this); };
                
                if (parseInt(id) === currentCategoryId) {
                    tab.classList.add('active');
                }
                
                tabsContainer.insertBefore(tab, addButton);
            });
        }

        function showMenuCategory(categoryId, tabElement) {
            currentCategoryId = categoryId;
            
            document.querySelectorAll('.menu-tabs .tab:not(.add-tab)').forEach(tab => {
                tab.classList.remove('active');
            });
            tabElement.classList.add('active');
            
            loadDishes(categoryId);
        }

        function loadDishes(categoryId) {
            fetch(`/api/dishes/${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderDishes(data.dishes);
                        updateCategoryTitle(categoryId);
                    } else {
                        showAlert('Error loading dishes: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading dishes:', error);
                    showAlert('Error loading dishes', 'error');
                });
        }

        function renderDishes(dishes) {
            const tbody = document.getElementById('dishes-tbody');
            const table = document.getElementById('dishes-table');
            const emptyState = document.getElementById('empty-state');
            
            if (dishes.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            tbody.innerHTML = dishes.map(dish => `
                <tr class="dish-row">
                    <td>
                        <div class="dish-name">${escapeHtml(dish.name)}</div>
                        <div class="dish-desc">${escapeHtml(dish.description || 'No description')}</div>
                    </td>
                    <td class="price">$${dish.price.toFixed(2)}</td>
                    <td class="quantity">${dish.quantity}</td>
                    <td>
                        <button class="btn-action btn-view" onclick="viewDishImages(${dish.id})" title="View Images">
                            <i class="fas fa-images"></i> View Images (${dish.images ? dish.images.length : 0})
                        </button>
                    </td>
                    <td class="actions">
                        <button class="btn-action btn-edit" onclick="editDish(${dish.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" onclick="deleteDish(${dish.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateCategoryTitle(categoryId) {
            document.getElementById('category-title').textContent = categories[categoryId] || 'Category';
        }

        function showAddDishModal() {
            isEditMode = false;
            document.getElementById('modal-title').textContent = 'Add New Dish';
            document.getElementById('submit-btn').textContent = 'Add Dish';
            document.getElementById('dish-form').reset();
            document.getElementById('dish-id').value = '';
            document.getElementById('category-id').value = currentCategoryId;
            updateImageSelectionInfo([]);
            document.getElementById('dish-modal').style.display = 'flex';
        }

        function showAddCategoryModal() {
            document.getElementById('category-form').reset();
            document.getElementById('category-modal').style.display = 'flex';
        }

        function editDish(dishId) {
            isEditMode = true;
            document.getElementById('modal-title').textContent = 'Edit Dish';
            document.getElementById('submit-btn').textContent = 'Update Dish';
            
            fetch(`/api/dish/${dishId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dish = data.dish;
                        document.getElementById('dish-id').value = dish.id;
                        document.getElementById('dish-name').value = dish.name;
                        document.getElementById('dish-price').value = dish.price;
                        document.getElementById('dish-quantity').value = dish.quantity;
                        document.getElementById('dish-description').value = dish.description || '';
                        updateImageSelectionInfo([]);
                        document.getElementById('dish-modal').style.display = 'flex';
                    } else {
                        showAlert('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading dish:', error);
                    showAlert('Error loading dish details', 'error');
                });
        }

        function viewDishImages(dishId) {
            fetch(`/api/dish/${dishId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dish = data.dish;
                        document.getElementById('images-modal-title').textContent = dish.name;
                        
                        document.getElementById('dish-details').innerHTML = `
                            <div class="dish-info">
                                <h4>${escapeHtml(dish.name)}</h4>
                                <p class="price">Price: $${dish.price.toFixed(2)}</p>
                                <p class="quantity">Quantity: ${dish.quantity}</p>
                                <p class="description">${escapeHtml(dish.description || 'No description available')}</p>
                            </div>
                        `;
                        
                        const imagesContainer = document.getElementById('dish-images-container');
                        if (dish.images && dish.images.length > 0) {
                            imagesContainer.innerHTML = `
                                <div class="images-section">
                                    <h5>Images (${dish.images.length})</h5>
                                    <div class="images-grid">
                                        ${dish.images.map(image => `
                                            <div class="image-placeholder">
                                                <i class="fas fa-image"></i>
                                                <p>${escapeHtml(image)}</p>
                                                <small>Image file stored</small>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        } else {
                            imagesContainer.innerHTML = `
                                <div class="no-images">
                                    <i class="fas fa-image"></i>
                                    <p>No images uploaded for this dish</p>
                                </div>
                            `;
                        }
                        
                        document.getElementById('images-modal').style.display = 'flex';
                    } else {
                        showAlert('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading dish images:', error);
                    showAlert('Error loading dish details', 'error');
                });
        }

        function deleteDish(dishId) {
            if (confirm('Are you sure you want to delete this dish? This action cannot be undone.')) {
                fetch('/api/delete-dish', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({dish_id: dishId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Dish deleted successfully');
                        loadDishes(currentCategoryId);
                    } else {
                        showAlert('Error: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting dish:', error);
                    showAlert('Error deleting dish', 'error');
                });
            }
        }

        function closeDishModal() {
            document.getElementById('dish-modal').style.display = 'none';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
        }

        function closeImagesModal() {
            document.getElementById('images-modal').style.display = 'none';
        }

        function updateImageSelectionInfo(files) {
            const infoDiv = document.getElementById('image-selection-info');
            
            if (files.length === 0) {
                infoDiv.innerHTML = '';
                return;
            }
            
            let infoHTML = `<div class="selected-images">`;
            for (let i = 0; i < files.length; i++) {
                infoHTML += `<span class="image-selected"><i class="fas fa-check-circle"></i> ${escapeHtml(files[i].name)}</span>`;
            }
            infoHTML += `</div><small class="image-count">${files.length} of 3 images selected</small>`;
            infoDiv.innerHTML = infoHTML;
        }

        // Form submissions
        document.getElementById('dish-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const url = isEditMode ? '/api/edit-dish' : '/api/add-dish';
            
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message);
                    closeDishModal();
                    loadDishes(currentCategoryId);
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving dish:', error);
                showAlert('Error saving dish', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });

        document.getElementById('category-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryName = document.getElementById('category-name').value.trim();
            
            if (!categoryName) {
                showAlert('Category name is required', 'error');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            fetch('/api/add-category', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name: categoryName})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message);
                    closeCategoryModal();
                    
                    categories[data.category.id] = data.category.name;
                    updateCategoryTabs();
                    
                    currentCategoryId = data.category.id;
                    const newTab = document.querySelector(`[data-category="${data.category.id}"]`);
                    if (newTab) {
                        document.querySelectorAll('.menu-tabs .tab:not(.add-tab)').forEach(tab => {
                            tab.classList.remove('active');
                        });
                        newTab.classList.add('active');
                        loadDishes(data.category.id);
                    }
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error adding category:', error);
                showAlert('Error adding category', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            });
        });

        document.getElementById('dish-images').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            if (files.length > 3) {
                showAlert('Maximum 3 images allowed. Please select only 3 images.', 'error');
                e.target.value = '';
                updateImageSelectionInfo([]);
                return;
            }
            
            const invalidFiles = files.filter(file => {
                const extension = file.name.split('.').pop().toLowerCase();
                return !['png', 'jpg', 'jpeg', 'gif'].includes(extension);
            });
            
            if (invalidFiles.length > 0) {
                showAlert('Only PNG, JPG, JPEG, and GIF files are allowed.', 'error');
                e.target.value = '';
                updateImageSelectionInfo([]);
                return;
            }
            
            updateImageSelectionInfo(files);
        });

        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            const modals = ['dish-modal', 'category-modal', 'images-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>