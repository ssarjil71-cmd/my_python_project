<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - HotelEase</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='manager_dashboard.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo">
                <i class="fas fa-hotel"></i>
                HotelEase
            </div>
        </div>
        <div class="nav-right">
            <div class="profile-dropdown">
                <div class="profile-btn" onclick="toggleProfile()">
                    <img src="https://via.placeholder.com/40x40/667eea/ffffff?text={{ manager_name[0] if manager_name else 'M' }}" alt="Profile" class="profile-img">
                    <span class="profile-name">{{ manager_name }}</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="profile-menu" id="profileMenu">
                    <a href="#"><i class="fas fa-user"></i> Profile Settings</a>
                    <a href="#"><i class="fas fa-cog"></i> Account Settings</a>
                    <a href="/" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-menu">
                <a href="#" class="menu-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Orders</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('waiters')">
                    <i class="fas fa-users"></i>
                    <span>Waiters</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('menu')">
                    <i class="fas fa-utensils"></i>
                    <span>Menu</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('verification')">
                    <i class="fas fa-check-circle"></i>
                    <span>Verification</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <a href="#" class="menu-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="page-header">
                    <h1>Dashboard Overview</h1>
                    <p>Welcome back, {{ manager_name }}! Here's what's happening today.</p>
                </div>

                <!-- Dashboard Cards -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-icon verification">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="card-content">
                            <h3>Today's Verification</h3>
                            <div class="card-number">24</div>
                            <p class="card-subtitle">Pending: 3</p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon orders">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="card-content">
                            <h3>Today's Orders</h3>
                            <div class="card-number">156</div>
                            <p class="card-subtitle">+12% from yesterday</p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon waiters">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3>Active Waiters</h3>
                            <div class="card-number">{{ waiters_count if waiters_count else 0 }}</div>
                            <p class="card-subtitle">On duty today</p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon menu">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="card-content">
                            <h3>Menu Items</h3>
                            <div class="card-number">89</div>
                            <p class="card-subtitle">Available today</p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-icon revenue">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-content">
                            <h3>Today's Revenue</h3>
                            <div class="card-number">$2,450</div>
                            <p class="card-subtitle">+8% from yesterday</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h2>Recent Activity</h2>
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-plus-circle"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>New order received</strong> - Table 12</p>
                                <span class="activity-time">2 minutes ago</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>Waiter verified</strong> - John Smith</p>
                                <span class="activity-time">15 minutes ago</span>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-utensils"></i>
                            </div>
                            <div class="activity-content">
                                <p><strong>Menu updated</strong> - Added 3 new items</p>
                                <span class="activity-time">1 hour ago</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other sections (hidden by default) -->
            <div id="orders" class="content-section">
                <div class="page-header">
                    <h1>Orders Management</h1>
                    <p>Manage tables, QR codes and view orders</p>
                </div>
                
                <!-- Orders Sub-Navigation -->
                <div class="sub-nav" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: flex; gap: 1rem;">
                    <button onclick="showOrdersSubSection('manage-tables')" class="sub-nav-btn active" id="manage-tables-btn">
                        <i class="fas fa-table"></i> Manage Tables
                    </button>
                    <button onclick="showOrdersSubSection('qr-orders')" class="sub-nav-btn" id="qr-orders-btn">
                        <i class="fas fa-shopping-cart"></i> View QR Orders
                    </button>
                </div>

                <!-- Manage Tables Sub-Section -->
                <div id="manage-tables-section" class="orders-sub-section active">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h2><i class="fas fa-table"></i> Manage Tables & QR Codes</h2>
                            <p style="color: #718096; margin-top: 0.5rem;">Create and manage table QR codes for guest ordering</p>
                        </div>
                        <button onclick="addNewTable()" class="btn-primary">
                            <i class="fas fa-plus"></i> Add Table
                        </button>
                    </div>
                    
                    <div id="tables-grid" class="tables-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Tables will be loaded here -->
                        <div style="text-align: center; padding: 3rem; color: #718096; grid-column: 1 / -1;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Loading tables...</p>
                        </div>
                    </div>
                </div>

                <!-- QR Orders Sub-Section -->
                <div id="qr-orders-section" class="orders-sub-section">
                    <div class="section-header" style="margin-bottom: 2rem;">
                        <h2><i class="fas fa-shopping-cart"></i> QR Orders</h2>
                        <p style="color: #718096; margin-top: 0.5rem;">Orders placed by guests via QR codes</p>
                    </div>
                    
                    <div id="orders-container">
                        <!-- Orders will be loaded here -->
                        <div style="text-align: center; padding: 3rem; color: #718096;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Loading orders...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="waiters" class="content-section">
                <div class="page-header">
                    <h1>Waiters Management</h1>
                    <p>Manage your restaurant staff</p>
                </div>
                
                <!-- Add Waiter Form -->
                <div class="form-card">
                    <h3>Add New Waiter</h3>
                    <div id="message" class="message"></div>
                    <form onsubmit="handleAddWaiter(event)" class="waiter-form">
                        <div class="form-group">
                            <label for="waiter-name">Waiter Name</label>
                            <input type="text" id="waiter-name" required placeholder="Enter waiter name">
                        </div>
                        <div class="form-group">
                            <label for="waiter-email">Email</label>
                            <input type="email" id="waiter-email" required placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label for="waiter-phone">Phone Number</label>
                            <input type="tel" id="waiter-phone" required placeholder="Enter phone number">
                        </div>
                        <button type="submit" class="btn-primary">Add Waiter</button>
                    </form>
                </div>

                <!-- Waiters List -->
                <div class="table-card">
                    <h3>Waiters List</h3>
                    <div class="waiters-list">
                        {{ waiters_html|safe }}
                    </div>
                </div>
            </div>

            <div id="menu" class="content-section">
                <div class="page-header">
                    <h1>Menu Management</h1>
                    <p>Manage your restaurant menu</p>
                </div>
                <div class="coming-soon">
                    <i class="fas fa-utensils"></i>
                    <h3>Menu Management</h3>
                    <p>This section is coming soon...</p>
                </div>
            </div>

            <div id="verification" class="content-section">
                <div class="page-header">
                    <h1>Guest Verification Dashboard</h1>
                    <p>Manage guest verification requests and share QR code for submissions</p>
                </div>

                <!-- Main Verification Content -->
                <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem;">
                    <!-- Left Section - Verification Table -->
                    <div class="table-card">
                        <h3><i class="fas fa-list-check"></i> Verification Requests</h3>
                        <div id="verification-content">
                            <div style="text-align: center; padding: 3rem; color: #718096;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <p>Loading verification requests...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right Section - QR Code -->
                    <div class="form-card" style="text-align: center; height: fit-content;">
                        <h3><i class="fas fa-qrcode"></i> Guest Access QR</h3>
                        <p style="color: #718096; margin-bottom: 1.5rem; font-size: 0.9rem;">Share this QR code with guests</p>
                        
                        <div id="qr-code-container">
                            <div style="background: #f7fafc; border: 2px dashed #cbd5e0; border-radius: 8px; padding: 2rem; margin: 1rem 0;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #718096;"></i>
                                <p style="color: #718096; margin-top: 1rem;">Generating QR Code...</p>
                            </div>
                        </div>
                        
                        <div id="public-url-container" style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; word-break: break-all; font-size: 0.8rem; text-align: left; display: none;">
                            <strong>Public Form URL:</strong><br>
                            <a href="#" target="_blank" style="color: #667eea; text-decoration: none;" id="public-url-link"></a>
                        </div>
                        
                        <button id="download-qr-btn" class="btn-primary" style="display: none;">
                            <i class="fas fa-download"></i> Download QR Code
                        </button>
                    </div>
                </div>
            </div>

            <div id="reports" class="content-section">
                <div class="page-header">
                    <h1>Reports & Analytics</h1>
                    <p>View detailed reports and analytics</p>
                </div>
                <div class="coming-soon">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Reports & Analytics</h3>
                    <p>This section is coming soon...</p>
                </div>
            </div>

            <div id="settings" class="content-section">
                <div class="page-header">
                    <h1>Settings</h1>
                    <p>Manage your account and preferences</p>
                </div>
                <div class="coming-soon">
                    <i class="fas fa-cog"></i>
                    <h3>Settings</h3>
                    <p>This section is coming soon...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2026 HotelEase - All Rights Reserved</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Support</a>
            </div>
        </div>
    </footer>

    <style>
        .sub-nav-btn {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
        }
        
        .sub-nav-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }
        
        .sub-nav-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .orders-sub-section {
            display: none;
        }
        
        .orders-sub-section.active {
            display: block;
        }
    </style>
    
    <script>
        const managerId = '{{ manager_id }}';
        
        // Orders Management Functions
        function showOrdersSubSection(subSection) {
            // Hide all sub-sections
            document.querySelectorAll('.orders-sub-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all sub-nav buttons
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected sub-section
            document.getElementById(subSection + '-section').classList.add('active');
            document.getElementById(subSection + '-btn').classList.add('active');
            
            // Load data based on sub-section
            if (subSection === 'manage-tables') {
                loadTablesData();
            } else if (subSection === 'qr-orders') {
                loadQROrdersData();
            }
        }
        
        function loadOrdersData() {
            // Load tables data by default when orders section is opened
            loadTablesData();
        }
        
        function loadTablesData() {
            fetch(`/orders/api/tables/${managerId}`)
                .then(response => response.json())
                .then(data => {
                    renderTablesGrid(data.tables);
                })
                .catch(error => {
                    console.error('Error loading tables:', error);
                    document.getElementById('tables-grid').innerHTML = 
                        '<div style="text-align: center; padding: 3rem; color: #ef4444; grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Error loading tables</p></div>';
                });
        }
        
        function renderTablesGrid(tables) {
            const container = document.getElementById('tables-grid');
            
            if (tables.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096; grid-column: 1 / -1;">
                        <i class="fas fa-table" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No Tables Yet</h3>
                        <p>Click "Add Table" to create your first table with QR code</p>
                    </div>
                `;
                return;
            }
            
            let gridHTML = '';
            tables.forEach(table => {
                gridHTML += `
                    <div class="table-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;">
                        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; color: #2d3748;">Table ${table.table_number}</h3>
                            <span style="background: #667eea; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${table.qr_code_no}</span>
                        </div>
                        <div class="qr-container" style="text-align: center; margin: 1.5rem 0;">
                            ${table.qr_image_path ? 
                                `<img src="/static/uploads/qr/table_${table.table_number}.png" alt="QR Code" style="max-width: 150px; border: 2px solid #e2e8f0; border-radius: 8px;">` :
                                '<div style="background: #f7fafc; border: 2px dashed #cbd5e0; border-radius: 8px; padding: 2rem; color: #718096;">QR Code</div>'
                            }
                        </div>
                        <div class="table-actions" style="text-align: center;">
                            <button onclick="downloadQR(${table.table_number})" class="btn-download" style="background: #10b981; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-download"></i> Download QR
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = gridHTML;
        }
        
        function loadQROrdersData() {
            fetch(`/orders/api/orders/${managerId}`)
                .then(response => response.json())
                .then(data => {
                    renderOrdersTable(data.orders);
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                    document.getElementById('orders-container').innerHTML = 
                        '<div style="text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Error loading orders</p></div>';
                });
        }
        
        function renderOrdersTable(orders) {
            const container = document.getElementById('orders-container');
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No QR Orders Yet</h3>
                        <p>Orders will appear here when guests place them via QR codes</p>
                        <button onclick="showOrdersSubSection('manage-tables')" style="background: #667eea; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer; margin-top: 1rem;">
                            <i class="fas fa-table"></i> Manage Tables
                        </button>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <div class="table-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Table Number</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">QR Number</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Ordered Items</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Total Amount</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Order Time</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Order Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            orders.forEach(order => {
                const statusColors = {
                    'New': 'background: #fef3c7; color: #92400e;',
                    'Preparing': 'background: #dbeafe; color: #1e40af;',
                    'Ready': 'background: #d1fae5; color: #065f46;',
                    'Completed': 'background: #d1fae5; color: #065f46;'
                };
                
                const itemsList = order.items.map(item => `${item.name} (x${item.quantity})`).join(', ');
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                        <td style="padding: 1rem; font-weight: 600; color: #2d3748;">Table ${order.table_number}</td>
                        <td style="padding: 1rem;">
                            <span style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${order.qr_code_no}</span>
                        </td>
                        <td style="padding: 1rem; max-width: 200px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${itemsList}">${itemsList}</div>
                        </td>
                        <td style="padding: 1rem; font-weight: 600;">$${order.total_amount.toFixed(2)}</td>
                        <td style="padding: 1rem; color: #718096;">
                            <div>${new Date(order.created_at).toLocaleDateString()}</div>
                            <div style="font-size: 0.8rem;">${new Date(order.created_at).toLocaleTimeString()}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; ${statusColors[order.status] || statusColors['New']}">
                                ${order.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }
        
        function addNewTable() {
            if (confirm('Add a new table with QR code?')) {
                fetch('/orders/api/add-table', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        manager_id: managerId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTablesData(); // Reload tables
                        alert('Table added successfully!');
                    } else {
                        console.error('Add table error:', data.message);
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Network error:', error);
                    alert('Network error. Please check your connection and try again.');
                });
            }
        }
        
        function downloadQR(tableNumber) {
            window.open(`/orders/download_qr/${tableNumber}`, '_blank');
        }
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked menu item
            event.target.closest('.menu-item').classList.add('active');
            
            // Load data based on section
            if (sectionId === 'verification') {
                loadVerificationData();
            } else if (sectionId === 'orders') {
                loadOrdersData();
            }
        }
        
        function toggleProfile() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('show');
        }
        
        function handleAddWaiter(event) {
            event.preventDefault();
            const name = document.getElementById('waiter-name').value;
            const email = document.getElementById('waiter-email').value;
            const phone = document.getElementById('waiter-phone').value;
            
            fetch('/hotel-manager/add-waiter', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, email, phone, manager_id: managerId})
            })
            .then(response => response.json())
            .then(data => {
                showMessage(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    document.querySelector('.waiter-form').reset();
                    setTimeout(() => { location.reload(); }, 1500);
                }
            });
        }
        
        function deleteWaiter(waiterId) {
            if (confirm('Are you sure you want to delete this waiter?')) {
                fetch('/hotel-manager/delete-waiter', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({waiter_id: waiterId, manager_id: managerId})
                })
                .then(response => response.json())
                .then(data => {
                    showMessage(data.message, data.success ? 'success' : 'error');
                    if (data.success) {
                        setTimeout(() => { location.reload(); }, 1500);
                    }
                });
            }
        }
        
        function showMessage(message, type) {
            const el = document.getElementById('message');
            el.textContent = message;
            el.className = 'message ' + type;
        }
        
        function logout() {
            window.location.href = '/';
        }
        
        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileDropdown = document.querySelector('.profile-dropdown');
            if (!profileDropdown.contains(event.target)) {
                document.getElementById('profileMenu').classList.remove('show');
            }
        });
        
        // Verification Dashboard Functions
        function loadVerificationData() {
            // Load verification requests
            fetch(`/guest-verification/api/verifications/${managerId}`)
                .then(response => response.json())
                .then(data => {
                    renderVerificationTable(data.verifications);
                })
                .catch(error => {
                    console.error('Error loading verification data:', error);
                    document.getElementById('verification-content').innerHTML = 
                        '<div style="text-align: center; padding: 3rem; color: #ef4444;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i><p>Error loading verification requests</p></div>';
                });
            
            // Load QR code
            loadQRCode();
        }
        
        function renderVerificationTable(verifications) {
            const container = document.getElementById('verification-content');
            
            if (verifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No Verification Requests</h3>
                        <p>Share the QR code with guests to start receiving verification requests</p>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                    <thead>
                        <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Guest Name</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Phone</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Submitted</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Status</th>
                            <th style="padding: 1rem; text-align: left; font-weight: 600; color: #4a5568;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            verifications.forEach(verification => {
                const statusClass = `status-${verification.status}`;
                const statusColors = {
                    'pending': 'background: #fef3c7; color: #92400e;',
                    'approved': 'background: #d1fae5; color: #065f46;',
                    'rejected': 'background: #fee2e2; color: #991b1b;'
                };
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f1f5f9;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 600; color: #2d3748;">${verification.guest_name}</div>
                            <div style="font-size: 0.8rem; color: #718096;">ID: ${verification.kyc_number}</div>
                        </td>
                        <td style="padding: 1rem;">${verification.phone}</td>
                        <td style="padding: 1rem;">
                            <div>${new Date(verification.submitted_at).toLocaleDateString()}</div>
                            <div style="font-size: 0.8rem; color: #718096;">${new Date(verification.submitted_at).toLocaleTimeString()}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; ${statusColors[verification.status]}">
                                ${verification.status}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            ${verification.status === 'pending' ? `
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="updateVerificationStatus(${verification.id}, 'approved')" style="background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button onclick="updateVerificationStatus(${verification.id}, 'rejected')" style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            ` : '<span style="color: #718096; font-size: 0.8rem;">No action needed</span>'}
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function loadQRCode() {
            fetch(`/guest-verification/api/qr-code/${managerId}`)
                .then(response => response.json())
                .then(data => {
                    const qrContainer = document.getElementById('qr-code-container');
                    const urlContainer = document.getElementById('public-url-container');
                    const downloadBtn = document.getElementById('download-qr-btn');
                    const urlLink = document.getElementById('public-url-link');
                    
                    qrContainer.innerHTML = `<img src="data:image/png;base64,${data.qr_code}" alt="QR Code" style="max-width: 200px; border: 3px solid #e2e8f0; border-radius: 12px;">`;
                    urlLink.href = data.public_url;
                    urlLink.textContent = data.public_url;
                    urlContainer.style.display = 'block';
                    downloadBtn.style.display = 'inline-block';
                    downloadBtn.onclick = () => window.open(`/guest-verification/download-qr/${managerId}`, '_blank');
                })
                .catch(error => {
                    console.error('Error loading QR code:', error);
                    document.getElementById('qr-code-container').innerHTML = 
                        '<div style="background: #fee2e2; border: 2px dashed #fca5a5; border-radius: 8px; padding: 2rem; color: #991b1b;"><i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i><p style="margin-top: 1rem;">Error loading QR code</p></div>';
                });
        }
        
        function updateVerificationStatus(verificationId, status) {
            if (confirm(`Are you sure you want to ${status} this verification request?`)) {
                fetch('/guest-verification/update-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        verification_id: verificationId,
                        status: status
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadVerificationData(); // Reload the data
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error updating status. Please try again.');
                });
            }
        }
    </script>
</body>
</html>